<%
internal = { :vendor_id => 1452, :product_id => 632, :description => "Internal Apple Keyboard" }
external_apple_bt = { :vendor_id => 1452, :product_id => 598, :description => "External Apple BT Keyboard" }
identifiers = [internal, external_apple_bt]
%>

{
    "title": "Personal rules @fnurl. All rules only apply to the internal and Apple BT.",
    "rules": [
        {
            "description": "Change caps_lock to Ctrl if pressed with other keys, to Escape if pressed alone (Internal KB and Apple BT KB).",
            "manipulators": [
                {
                    "conditions": [ 
                      { "type": "device_if",
                        "identifiers": <%= identifiers.to_json %>
                      }
                    ],
                    "type": "basic",
                    "from": <%= from("caps_lock", [], ["any"]) %>,
                    "to": <%= to([["left_control"]]) %>,
                    "to_if_alone": <%= to([["escape"]]) %>
                }
            ]
        },
        {
            "description": "Change Left Ctrl to Hyper (Shift, Opt, Ctrl Cmd) (Internal KB and Apple BT KB).",
            "manipulators": [
                {
                    "conditions": [ 
                      { "type": "device_if",
                        "identifiers": <%= identifiers.to_json %>
                      }
                    ],
                    "type": "basic",
                    "from": <%= from("left_control", [], []) %>,
                    "to": <%= to([["left_command", ["left_shift", "left_option", "left_control"]]]) %>
                }
            ]
        },
        {
            "description": "Arrow mode: R Opt as Arrow Mode (Internal KB and Apple BT KB).",
            "manipulators": [
                {
                    "conditions": [ 
                      { "type": "device_if",
                        "identifiers": <%= identifiers.to_json %>
                      }
                    ],
                    "type": "basic",
                    "from": <%= from("right_option", [], []) %>,
                    "to": [ { "set_variable": { "name": "arrow_mode", "value": 1 } } ],
                    "to_after_key_up": [ { "set_variable": { "name": "arrow_mode", "value": 0 } } ]
                }
            ]
        },
        {
            "description": "Arrow mode: open_bracket, semicolon, quote, backslash as arrows (Internal KB and Apple BT KB).",
            "manipulators": [
                {
                    <%# ArrowFn+[ to up arrow %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                    { "type": "variable_if", "name": "arrow_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("open_bracket", [], []) %>,
                    "to": <%= to([["up_arrow"]]) %>
                },

                {
                    <%# ArrowFn+; to left arrow %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                    { "type": "variable_if", "name": "arrow_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("semicolon", [], []) %>,
                    "to": <%= to([["left_arrow"]]) %>
                },
                {
                    <%# ArrowFn+' to down arrow %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "arrow_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("quote", [], []) %>,
                    "to": <%= to([["down_arrow"]]) %>
                },
                {
                    <%# ArrowFn+\ to right arrow %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "arrow_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("backslash", [], []) %>,
                    "to": <%= to([["right_arrow"]]) %>
                },
                {
                    <%# ArrowFn+\ to right arrow %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "arrow_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("close_bracket", [], []) %>,
                    "to": <%= to([["right_arrow"]]) %>
                }
            ]
        },
        {
            "description": "Map open_bracket, quote and semicolon to Swedish chars on keypad (Internal KB and Apple BT KB).",
            "manipulators": [
                {
                    "conditions": [ { "type": "device_if",
                                      "identifiers": <%= identifiers.to_json %> },
                                    { "type": "variable_if", "name": "symbolfn_mode1", "value": 0 },
                                    { "type": "variable_if", "name": "symbolfn_mode2", "value": 0 },
                                    { "type": "variable_if", "name": "arrow_mode", "value": 0 } ],
                    "type": "basic",
                    "from": <%= from("open_bracket", [], ["any"]) %>,
                    "to": <%= to([["keypad_7"]]) %>
                },
                {
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %> },
                                    { "type": "variable_if", "name": "symbolfn_mode1", "value": 0 },
                                    { "type": "variable_if", "name": "symbolfn_mode2", "value": 0 },
                                    { "type": "variable_if", "name": "arrow_mode", "value": 0 } ],
                    "type": "basic",
                    "from": <%= from("quote", [], ["any"]) %>,
                    "to": <%= to([["keypad_8"]]) %>
                },
                {
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %> },
                                    { "type": "variable_if", "name": "symbolfn_mode1", "value": 0 },
                                    { "type": "variable_if", "name": "symbolfn_mode2", "value": 0 },
                                    { "type": "variable_if", "name": "arrow_mode", "value": 0 } ],
                    "type": "basic",
                    "from": <%= from("semicolon", [], ["any"]) %>,
                    "to": <%= to([["keypad_9"]]) %>
                }
            ]
        },
        {
            "description": "SpaceFN: Space enables SpaceFN mode (Internal KB and Apple BT KB).",
            "manipulators": [
                {
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %> } ],
                    "type": "basic",
                    "from": <%= from("spacebar", [], ["any"]) %>,
                    "to": [ { "set_variable": { "name": "spacefn_mode", "value": 1 } } ],
                    "to_after_key_up": [ { "set_variable": { "name": "spacefn_mode", "value": 0 } } ],
                    "to_if_alone": <%= to([["spacebar"]]) %>
                }
            ]
        },
        {
            "description": "SpaceFN: Space+[sdfghjkl] to parens (Internal KB and Apple BT KB).",
            "manipulators": [
                {
                    <%# SpaceFn+g to left square bracket, [ %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %> },
                                    { "type": "variable_if", "name": "spacefn_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("g", [], []) %>,
                    "to": <%= to([["open_bracket"]]) %>
                },
                {
                    <%# SpaceFn+f to left parenthesis, ( %>
                    "conditions": [ { "type": "device_if",
                                      "identifiers": <%= identifiers.to_json %> },
                                    { "type": "variable_if", "name": "spacefn_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("f", [], []) %>,
                    "to": <%= to([["9", ["left_shift"]]]) %>
                },
                {
                    <%# SpaceFn+d to left curly bracket, { %>
                    "conditions": [ { "type": "device_if",
                                      "identifiers": <%= identifiers.to_json %> },
                                    { "type": "variable_if", "name": "spacefn_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("d", [], []) %>,
                    "to": <%= to([["open_bracket", ["left_shift"]]]) %>
                },
                {
                    <%# SpaceFn+s to less than, < %>
                    "conditions": [ { "type": "device_if",
                                      "identifiers": <%= identifiers.to_json %> },
                                    { "type": "variable_if", "name": "spacefn_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("s", [], []) %>,
                    "to": <%= to([["comma", ["left_shift"]]]) %>
                },
                {
                    <%# SpaceFn+h to right square bracket, ] %>
                    "conditions": [ { "type": "device_if",
                                      "identifiers": <%= identifiers.to_json %> },
                                    { "type": "variable_if", "name": "spacefn_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("h", [], []) %>,
                    "to": <%= to([["close_bracket"]]) %>
                },
                {
                    <%# SpaceFn+j to right parenthesis, ) %>
                    "conditions": [ { "type": "device_if",
                                      "identifiers": <%= identifiers.to_json %> },
                                    { "type": "variable_if", "name": "spacefn_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("j", [], []) %>,
                    "to": <%= to([["0", ["left_shift"]]]) %>
                },
                {
                    <%# SpaceFn+k to right curly bracket, } %>
                    "conditions": [ { "type": "device_if",
                                      "identifiers": <%= identifiers.to_json %> },
                                    { "type": "variable_if", "name": "spacefn_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("k", [], []) %>,
                    "to": <%= to([["close_bracket", ["left_shift"]]]) %>
                },
                {
                    <%# SpaceFn+l to greater than, > %>
                    "conditions": [ { "type": "device_if",
                                      "identifiers": <%= identifiers.to_json %> },
                                    { "type": "variable_if", "name": "spacefn_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("l", [], []) %>,
                    "to": <%= to([["period", ["left_shift"]]]) %>
                }
            ]
        },
        {
            "description": "SpaceFN: Space+[cvbnm,] to dashes, colons and quotes (Internal KB and Apple BT KB).",
            "manipulators": [
                {
                    <%# SpaceFn+v to hyphen, - %>
                    "conditions": [ { "type": "device_if",
                                      "identifiers": <%= identifiers.to_json %> },
                                    { "type": "variable_if", "name": "spacefn_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("v", [], []) %>,
                    "to": <%= to([["hyphen"]]) %>
                },
                {
                    <%# SpaceFn+c to underscore, _ %>
                    "conditions": [ { "type": "device_if",
                                      "identifiers": <%= identifiers.to_json %> },
                                    { "type": "variable_if", "name": "spacefn_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("c", [], []) %>,
                    "to": <%= to([["hyphen", ["left_shift"]]]) %>
                },
                {
                    <%# SpaceFn+b to colon, : %>
                    "conditions": [ { "type": "device_if",
                                      "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "spacefn_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("b", [], []) %>,
                    "to": <%= to([["semicolon", ["left_shift"]]]) %>
                },
                {
                    <%# SpaceFn+n to semicolon %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "spacefn_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("n", [], []) %>,
                    "to": <%= to([["semicolon"]]) %>
                },
                {
                    <%# SpaceFn+m to double quote, " %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "spacefn_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("m", [], []) %>,
                    "to": <%= to([["quote", ["left_shift"]]]) %>
                },
                {
                    <%# SpaceFn+, to single quote, ' %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "spacefn_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("comma", [], []) %>,
                    "to": <%= to([["quote"]]) %>
                },
                {
                    <%# SpaceFn+. to pipe, | %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "spacefn_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("period", [], []) %>,
                    "to": <%= to([["backslash", ["left_shift"]]]) %>
                },
                {
                    <%# SpaceFn+/ to backslash, \ %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "spacefn_mode", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("slash", [], []) %>,
                    "to": <%= to([["backslash"]]) %>
                }
            ]
        },
        {
            "description": "SymbolFn 1 & 2: d+f enables Symbol mode 1, j+k enables symbol mode 2 (Internal KB and Apple BT KB).",
            "manipulators": [
                {
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "symbolfn_mode2", "value": 0 } ],
                    "type": "basic",
                    "from": { "simultaneous": [ { "key_code": "d" }, { "key_code": "f" } ] },
                    "to": [ { "set_variable": { "name": "symbolfn_mode1", "value": 1 } } ],
                    "to_after_key_up": [ { "set_variable": { "name": "symbolfn_mode1", "value": 0 } } ]
                },
                {
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "symbolfn_mode1", "value": 0 } ],
                    "type": "basic",
                    "from": { "simultaneous": [ { "key_code": "j" }, { "key_code": "k" } ] },
                    "to": [ { "set_variable": { "name": "symbolfn_mode2", "value": 1 } } ],
                    "to_after_key_up": [ { "set_variable": { "name": "symbolfn_mode2", "value": 0 } } ]
                }
            ]
        },
        {
            "description": "SymbolFn 1: SymbolFn1+[hjkl;] to *$=&% (Internal KB and Apple BT KB).",
            "manipulators": [
                {
                    <%# SymbolFn1+j+k to return %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "symbolfn_mode1", "value": 1 } ],
                    "type": "basic",
                    "from": { "simultaneous": [ { "key_code": "j" }, { "key_code": "k" } ] },
                    "to": <%= to([["return_or_enter"]]) %>
                },
                {
                    <%# SymbolFn1+n to return %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "symbolfn_mode1", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("n", [], []) %>,
                    "to": <%= to([["return_or_enter"]]) %>
                },
                {
                    <%# SymbolFn1+h to * %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "symbolfn_mode1", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("h", [], []) %>,
                    "to": <%= to([["8", ["left_shift"]]]) %>
                },
                {
                    <%# SymbolFn1+j to $ %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "symbolfn_mode1", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("j", [], []) %>,
                    "to": <%= to([["4", ["left_shift"]]]) %>
                },
                {
                    <%# SymbolFn1+k to * %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "symbolfn_mode1", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("k", [], []) %>,
                    "to": <%= to([["equal_sign"]]) %>
                },
                {
                    <%# SymbolFn1+l to & %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "symbolfn_mode1", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("l", [], []) %>,
                    "to": <%= to([["7", ["left_shift"]]]) %>
                },
                {
                    <%# SymbolFn1+; to % %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "symbolfn_mode1", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("semicolon", [], []) %>,
                    "to": <%= to([["5", ["left_shift"]]]) %>
                }
            ]
        },
        {
            "description": "SymbolFn 2: SymbolFn2+[asdfg] to !@#^+ (Internal KB and Apple BT KB).",
            "manipulators": [
                {
                    <%# SymbolFn2+d+f to backspace %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "symbolfn_mode2", "value": 1 } ],
                    "type": "basic",
                    "from": { "simultaneous": [ { "key_code": "d" }, { "key_code": "f" } ] },
                    "to": <%= to([["delete_or_backspace"]]) %>
                },
                {
                    <%# SymbolFn2+v to backspace %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "symbolfn_mode2", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("v", [], []) %>,
                    "to": <%= to([["delete_or_backspace"]]) %>
                },
                {
                    <%# SymbolFn2+a to ! %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "symbolfn_mode2", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("a", [], []) %>,
                    "to": <%= to([["1", ["left_shift"]]]) %>
                },
                {
                    <%# SymbolFn2+s to @ %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "symbolfn_mode2", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("s", [], []) %>,
                    "to": <%= to([["2", ["left_shift"]]]) %>
                },
                {
                    <%# SymbolFn2+d to # %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "symbolfn_mode2", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("d", [], []) %>,
                    "to": <%= to([["3", ["left_shift"]]]) %>
                },
                {
                    <%# SymbolFn2+f to ^ %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "symbolfn_mode2", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("f", [], []) %>,
                    "to": <%= to([["6", ["left_shift"]]]) %>
                },
                {
                    <%# SymbolFn2+g to + %>
                    "conditions": [ { "type": "device_if",
                                    "identifiers": <%= identifiers.to_json %>
                                    },
                                  { "type": "variable_if", "name": "symbolfn_mode2", "value": 1 } ],
                    "type": "basic",
                    "from": <%= from("g", [], []) %>,
                    "to": <%= to([["equal_sign", ["left_shift"]]]) %>
                }
            ]
        }
    ]
}

